# Session Notes - January 15, 2026

## Summary

Continued work on Subscription Incinerator app, focusing on category/bill type feature and fixing email scanning.

## Completed Features

### 1. Bill Type/Category Feature (from previous session)
- Added preset categories: Entertainment, Music, Streaming, Gaming, Software, Productivity, Cloud Storage, News, Education, Fitness, Finance, Shopping, Food, Transportation, Utilities, Insurance, Healthcare, Home, Communication, Business
- Category dropdown in Add Subscription form
- Category dropdown in Edit Subscription modal
- Category badge with icons on subscription cards
- API endpoint: `/api/categories`
- Files: `lib/categories/presets.ts`, `app/api/categories/route.ts`

### 2. Email Scanning Fix
**Problem:** Email scan would start but get 0 emails - appeared to hang.

**Root Causes:**
1. BullMQ worker wasn't running (only dev server was running)
2. Fetching 500+ emails sequentially was too slow (each message = separate API call)

**Fixes:**
- Added parallel batching to `lib/email/gmail-client.ts` - fetches 10 messages concurrently
- Added progress logging to show batch progress
- Worker must be running: `npm run worker` or `npm run dev:all`

**Results after fix:**
- 784 emails scanned in ~1 minute
- 45 potential subscriptions detected (35 pattern, 10 frequency)
- 0 new created (already existed in subscription list)

## Key Commands

```bash
# Run dev server only
npm run dev

# Run worker only (processes background jobs)
npm run worker

# Run both dev server and worker
npm run dev:all

# Test Gmail API connection
npx tsx test-gmail-api.ts

# Test scan queries
npx tsx test-scan.ts
```

## Important Files Modified

- `lib/email/gmail-client.ts` - Added parallel batching for message fetching
- `components/subscriptions/subscription-card.tsx` - Shows category badge
- `components/subscriptions/edit-subscription-modal.tsx` - Category dropdown
- `components/subscriptions/add-subscription-form.tsx` - Category dropdown

## Reminder Infrastructure (Already Exists)

The app already has reminder infrastructure:
- `lib/notifications/schedule-reminders.ts` - Schedules BullMQ jobs 7d, 24h before billing
- `lib/notifications/email.ts` - Sends emails via Resend
- `lib/notifications/templates.ts` - HTML email templates
- `workers/processors/reminder-sender.ts` - Processes reminder jobs
- Prisma models: `Reminder`, `PushSubscription`, User `notificationPreferences`

**Not yet implemented:**
- Web push notification sending
- Calendar integration (.ics or Google Calendar)
- Settings UI to toggle notifications

## Debugging Tips

### Email scan not working?
1. Check if worker is running: `ps aux | grep worker`
2. Check Redis queue: `redis-cli LRANGE bull:email-scanning:active 0 -1`
3. Clear stuck jobs: `redis-cli LREM bull:email-scanning:active 0 "job-id"`
4. Check worker logs in terminal or `/tmp/claude/.../tasks/*.output`

### Gmail API issues?
1. Run `npx tsx test-gmail-api.ts` to verify connection
2. Check if tokens are valid (stored in `users.oauth_tokens`)
3. Ensure Gmail API is enabled in Google Cloud Console

## Next Session Ideas

User asked about subscription due date reminders:
1. Calendar export (.ics download)
2. Google Calendar sync (auto-add events)
3. Web push notifications
4. Settings UI to toggle reminders on/off
