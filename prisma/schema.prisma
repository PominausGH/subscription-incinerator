generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model accounts {
  id                  String  @id
  user_id             String
  type                String
  provider            String
  provider_account_id String
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?
  users               users   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_account_id])
}

model bank_imports {
  id                    String   @id
  user_id               String
  file_name             String
  total_transactions    Int
  recurring_detected    Int
  subscriptions_created Int
  created_at            DateTime @default(now())
  users                 users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model cancellation_attempts {
  id               String        @id
  subscription_id  String
  method           String?
  status           String        @default("pending")
  error_message    String?
  credentials_used Json?
  attempted_at     DateTime      @default(now())
  completed_at     DateTime?
  subscriptions    subscriptions @relation(fields: [subscription_id], references: [id], onDelete: Cascade)

  @@index([subscription_id])
}

model categories {
  id            String          @id
  name          String
  user_id       String?
  is_preset     Boolean         @default(false)
  created_at    DateTime        @default(now())
  updated_at    DateTime
  users         users?          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  subscriptions subscriptions[]

  @@unique([name, user_id])
  @@index([user_id])
}

model merchant_aliases {
  id           String @id
  bank_pattern String @unique
  service_name String
}

model pending_subscriptions {
  id                String    @id
  user_id           String
  service_name      String
  confidence        Decimal   @db.Decimal(3, 2)
  amount            Decimal?  @db.Decimal(10, 2)
  currency          String    @default("USD")
  is_trial          Boolean   @default(false)
  trial_ends_at     DateTime?
  next_billing_date DateTime?
  email_id          String
  email_subject     String
  email_from        String
  email_date        DateTime
  raw_email_data    Json?
  status            String    @default("pending")
  created_at        DateTime  @default(now())
  expires_at        DateTime
  billing_cycle     String?
  users             users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([expires_at])
  @@index([user_id, status])
}

model push_subscriptions {
  id            String   @id
  user_id       String
  endpoint_data Json
  active        Boolean  @default(true)
  created_at    DateTime @default(now())
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, active])
}

model reminders {
  id              String        @id
  subscription_id String
  reminder_type   String
  scheduled_for   DateTime
  sent_at         DateTime?
  channels_used   String[]
  job_id          String?
  status          String        @default("pending")
  created_at      DateTime      @default(now())
  subscriptions   subscriptions @relation(fields: [subscription_id], references: [id], onDelete: Cascade)

  @@index([scheduled_for, status])
  @@index([subscription_id])
}

model service_configs {
  id                        String   @id
  service_name              String   @unique
  has_api                   Boolean  @default(false)
  api_endpoint              String?
  api_auth_type             String?
  login_url                 String?
  cancellation_url          String?
  cancel_button_selector    String?
  confirm_selector          String?
  success_indicator         String?
  cancellation_instructions Json?
  email_patterns            Json?
  logo_url                  String?
  support_url               String?
  created_at                DateTime @default(now())
  updated_at                DateTime
}

model sessions {
  id            String   @id
  session_token String   @unique
  user_id       String
  expires       DateTime
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model subscriptions {
  id                    String                  @id
  user_id               String
  service_name          String
  status                String                  @default("active")
  billing_cycle         String?
  amount                Decimal?                @db.Decimal(10, 2)
  currency              String                  @default("USD")
  trial_ends_at         DateTime?
  next_billing_date     DateTime?
  cancellation_url      String?
  auto_cancel_enabled   Boolean                 @default(false)
  detected_from         String?
  type                  SubscriptionType        @default(PERSONAL)
  category_id           String?
  raw_email_data        Json?
  bank_transaction_data Json?
  external_id           String?
  created_at            DateTime                @default(now())
  updated_at            DateTime
  reminder_settings     Json?
  cancellation_attempts cancellation_attempts[]
  reminders             reminders[]
  categories            categories?             @relation(fields: [category_id], references: [id])
  users                 users                   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([next_billing_date])
  @@index([user_id])
  @@index([user_id, status])
}

model users {
  id                       String                  @id
  email                    String                  @unique
  email_verified           DateTime?
  name                     String?
  created_at               DateTime                @default(now())
  updated_at               DateTime
  oauth_tokens             Json?
  email_provider           String?
  tier                     String                  @default("free")
  notification_preferences Json                    @default("{\"sms\": false, \"push\": true, \"email\": true}")
  phone_number             String?
  phone_verified           Boolean                 @default(false)
  stripe_customer_id       String?                 @unique
  home_currency            String                  @default("USD")
  accounts                 accounts[]
  bank_imports             bank_imports[]
  categories               categories[]
  pending_subscriptions    pending_subscriptions[]
  push_subscriptions       push_subscriptions[]
  sessions                 sessions[]
  subscriptions            subscriptions[]
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum SubscriptionType {
  PERSONAL
  BUSINESS
}
