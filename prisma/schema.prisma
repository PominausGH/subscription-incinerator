generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  name          String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // OAuth tokens (encrypted)
  oauthTokens     Json?   @map("oauth_tokens")
  emailProvider   String? @map("email_provider") // 'gmail', 'outlook', null

  // Subscription tier
  tier            String  @default("free") // 'free', 'premium'

  // Notification preferences
  notificationPreferences Json @default("{\"email\": true, \"push\": true, \"sms\": false}") @map("notification_preferences")

  // Phone (for SMS)
  phoneNumber     String?  @map("phone_number")
  phoneVerified   Boolean  @default(false) @map("phone_verified")

  // Stripe
  stripeCustomerId String? @unique @map("stripe_customer_id")

  // Relations
  subscriptions        Subscription[]
  pendingSubscriptions PendingSubscription[]
  pushSubscriptions    PushSubscription[]
  accounts             Account[]
  sessions             Session[]

  @@map("users")
}

// NextAuth models
model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Subscription {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  serviceName String   @map("service_name")
  status      String   @default("active") // 'trial', 'active', 'cancelled', 'expired'

  billingCycle String?   @map("billing_cycle") // 'monthly', 'yearly', 'custom'
  amount       Decimal?  @db.Decimal(10, 2)
  currency     String    @default("USD")

  trialEndsAt     DateTime? @map("trial_ends_at")
  nextBillingDate DateTime? @map("next_billing_date")

  cancellationUrl    String?  @map("cancellation_url") @db.Text
  autoCancelEnabled  Boolean  @default(false) @map("auto_cancel_enabled")

  detectedFrom  String? @map("detected_from") // 'email_scan', 'manual', 'api'
  rawEmailData  Json?   @map("raw_email_data")
  externalId    String? @map("external_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  reminders            Reminder[]
  cancellationAttempts CancellationAttempt[]

  @@index([userId])
  @@index([userId, status])
  @@index([nextBillingDate])
  @@map("subscriptions")
}

model PendingSubscription {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")

  // Detection data
  serviceName String   @map("service_name")
  confidence  Decimal  @db.Decimal(3, 2)
  amount      Decimal? @db.Decimal(10, 2)
  currency    String   @default("USD")

  isTrial         Boolean   @default(false) @map("is_trial")
  trialEndsAt     DateTime? @map("trial_ends_at")
  nextBillingDate DateTime? @map("next_billing_date")

  // Source email data
  emailId      String   @map("email_id")
  emailSubject String   @map("email_subject")
  emailFrom    String   @map("email_from")
  emailDate    DateTime @map("email_date")
  rawEmailData Json?    @map("raw_email_data")

  // Lifecycle
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([expiresAt])
  @@map("pending_subscriptions")
}

model Reminder {
  id             String    @id @default(uuid())
  subscriptionId String    @map("subscription_id")
  reminderType   String    @map("reminder_type") // 'trial_ending', 'billing_upcoming', 'cancellation_failed'
  scheduledFor   DateTime  @map("scheduled_for")
  sentAt         DateTime? @map("sent_at")
  channelsUsed   String[]  @map("channels_used")
  jobId          String?   @map("job_id")
  status         String    @default("pending") // 'pending', 'sent', 'failed'
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([scheduledFor, status])
  @@map("reminders")
}

model CancellationAttempt {
  id              String    @id @default(uuid())
  subscriptionId  String    @map("subscription_id")
  method          String?   // 'api', 'automation', 'manual_script'
  status          String    @default("pending") // 'pending', 'success', 'failed', 'requires_manual'
  errorMessage    String?   @map("error_message") @db.Text
  credentialsUsed Json?     @map("credentials_used")
  attemptedAt     DateTime  @default(now()) @map("attempted_at")
  completedAt     DateTime? @map("completed_at")

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("cancellation_attempts")
}

model ServiceConfig {
  id          String   @id @default(uuid())
  serviceName String   @unique @map("service_name")

  hasApi          Boolean @default(false) @map("has_api")
  apiEndpoint     String? @map("api_endpoint") @db.Text
  apiAuthType     String? @map("api_auth_type")

  loginUrl              String? @map("login_url") @db.Text
  cancellationUrl       String? @map("cancellation_url") @db.Text
  cancelButtonSelector  String? @map("cancel_button_selector")
  confirmSelector       String? @map("confirm_selector")
  successIndicator      String? @map("success_indicator")

  cancellationInstructions Json?   @map("cancellation_instructions")
  emailPatterns            Json?   @map("email_patterns")

  logoUrl    String? @map("logo_url") @db.Text
  supportUrl String? @map("support_url") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("service_configs")
}

model PushSubscription {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  endpointData Json     @map("endpoint_data")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, active])
  @@map("push_subscriptions")
}
